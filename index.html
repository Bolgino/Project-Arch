<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Punto ArchiQuadro - Magazzino & Memoria</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --green: #1b5e20; --gold: #fbc02d; --red: #d32f2f; --bg: #f4f4f4; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; padding: 20px; }
        .container { max-width: 1200px; margin: auto; }
        .header { background: var(--green); color: white; padding: 20px; border-radius: 12px; display: flex; justify-content: space-between; align-items: center; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; margin-top: 20px; }
        .card { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); text-align: center; border: 1px solid #ddd; }
        .card img { height: 120px; object-fit: contain; margin-bottom: 10px; border-radius: 8px; }
        .qty-box { display: flex; align-items: center; justify-content: center; gap: 10px; margin: 15px 0; }
        .qty-input { width: 50px; text-align: center; font-weight: bold; padding: 5px; border-radius: 5px; border: 1px solid #ccc; }
        .btn { background: var(--green); color: white; border: none; padding: 12px; border-radius: 8px; cursor: pointer; width: 100%; font-weight: bold; transition: 0.3s; }
        .btn:hover { opacity: 0.8; }
        .btn-pack { background: var(--gold); color: #333; margin-bottom: 10px; border: 2px solid #b8860b; }
        .out-of-stock { color: var(--red); font-weight: bold; padding: 10px; border: 2px solid var(--red); border-radius: 8px; }
        #admin-panel { display: none; background: #fff3e0; padding: 30px; border-radius: 20px; margin-top: 40px; border: 2px dashed #ff9800; }
        .admin-nav { margin-bottom: 20px; display: flex; gap: 10px; }
        input, textarea { width: 100%; padding: 10px; margin: 10px 0; border-radius: 8px; border: 1px solid #ccc; box-sizing: border-box; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>‚öúÔ∏è Punto ArchiQuadro</h1>
        <div id="auth-buttons">
            <button onclick="loginAdmin()" id="btn-login" style="padding:10px; cursor:pointer; border-radius:8px; border:none;">Login Admin</button>
            <button onclick="logoutAdmin()" id="btn-logout" style="display:none; padding:10px; cursor:pointer; border-radius:8px; border:none; background:var(--red); color:white;">Esci</button>
        </div>
    </div>

    <div id="public-view">
        <h2 style="color:var(--green)">üéÅ Pacchetti Veloci</h2>
        <div id="pacchetti-lista" class="grid"></div>
        
        <h2 style="color:var(--green); margin-top:40px;">üì¶ Magazzino Singolo</h2>
        <div id="oggetti-lista" class="grid"></div>
    </div>

    <div id="admin-panel">
        <h2 style="color:#e65100">üõ†Ô∏è Pannello Super-Admin</h2>
        <div class="admin-nav">
            <button class="btn" onclick="showSection('prodotti')" style="width:auto; background:#e65100">Aggiungi Prodotto</button>
            <button class="btn" onclick="showSection('archivio')" style="width:auto; background:#e65100">Nuova Memoria</button>
        </div>
        <div id="admin-content" style="background:white; padding:20px; border-radius:10px;">
            <p>Seleziona un'azione per gestire il magazzino o l'archivio.</p>
        </div>
    </div>
</div>

<script>
    // --- CONFIGURAZIONE E SICUREZZA ---
    const PROJECT_ID = "jmildwxjaviqkrkhjzhl";
    const ADMIN_EMAIL = "marcobolge@gmail.com";
    
    let sbUrl = localStorage.getItem('sb-url');
    let sbKey = localStorage.getItem('sb-key');

    // Chiedo i dati se mancano per evitare "supabaseUrl is required"
    if (!sbUrl || sbUrl === "null" || sbUrl.length < 10) {
        sbUrl = prompt("Configurazione: Inserisci URL Supabase (es: https://abc.supabase.co)");
        sbKey = prompt("Configurazione: Inserisci API Key (anon public)");
        if (sbUrl && sbKey) {
            localStorage.setItem('sb-url', sbUrl.trim());
            localStorage.setItem('sb-key', sbKey.trim());
            location.reload();
        }
    }

    const _supabase = supabase.createClient(sbUrl, sbKey);

    async function init() {
        checkAdmin();
        loadInventory();
        loadPacks();
    }

    // --- CARICAMENTO DATI ---
    async function loadInventory() {
        const { data: oggetti, error } = await _supabase.from('oggetti').select('*').order('nome');
        if (error) return console.error("Errore caricamento:", error);
        
        const container = document.getElementById('oggetti-lista');
        container.innerHTML = oggetti.map(o => {
            const isOut = o.quantita_disponibile <= 0;
            return `
                <div class="card">
                    <img src="${o.foto_url || 'https://via.placeholder.com/150?text=üì¶'}" alt="${o.nome}">
                    <h3>${o.nome}</h3>
                    ${isOut ? `<div class="out-of-stock">ESAURITO</div>` : 
                    `<p>Disp: <strong>${o.quantita_disponibile}</strong></p>
                     <div class="qty-box">
                        <button onclick="changeQtyValue('${o.id}', -1)">-</button>
                        <input type="number" id="qty-${o.id}" class="qty-input" value="1" min="1" max="${o.quantita_disponibile}">
                        <button onclick="changeQtyValue('${o.id}', 1)">+</button>
                     </div>
                     <button class="btn" onclick="confermaPrelievo('${o.id}', '${o.nome}', ${o.quantita_disponibile})">Conferma Prelievo</button>`}
                </div>`;
        }).join('');
    }

    async function loadPacks() {
        const { data: pacchetti } = await _supabase.from('pacchetti').select('*');
        const container = document.getElementById('pacchetti-lista');
        if (pacchetti) {
            container.innerHTML = pacchetti.map(p => `
                <div class="card" style="border: 2px solid var(--gold)">
                    <h3>${p.nome}</h3>
                    <p>${p.descrizione || 'Kit completo scout'}</p>
                    <button class="btn btn-pack" onclick="prelevaPacchetto('${p.id}', '${p.nome}')">Scarica Pacchetto</button>
                </div>
            `).join('');
        }
    }

    // --- LOGICA PRELIEVI ED EMAIL ---
    async function confermaPrelievo(id, nome, attuale) {
        const qty = parseInt(document.getElementById(`qty-${id}`).value);
        if(!confirm(`Confermi di prelevare ${qty}x ${nome}?`)) return;

        const { error } = await _supabase.from('oggetti').update({ quantita_disponibile: attuale - qty }).eq('id', id);
        if(!error) {
            await callEmailFunction(`üì¶ PRELIEVO: ${qty}x ${nome}. Rimanenti: ${attuale - qty}`);
            alert("Operazione riuscita! Mail inviata all'admin.");
            loadInventory();
        }
    }

    async function prelevaPacchetto(packId, packNome) {
        if(!confirm(`Vuoi scaricare tutti i componenti del pacchetto "${packNome}"?`)) return;
        
        const { data: componenti } = await _supabase.from('componenti_pacchetto')
            .select('oggetto_id, quantita_necessaria, oggetti(nome, quantita_disponibile)')
            .eq('pacchetto_id', packId);
        
        if (componenti) {
            for (const comp of componenti) {
                const nuovaQty = comp.oggetti.quantita_disponibile - comp.quantita_necessaria;
                await _supabase.from('oggetti').update({ quantita_disponibile: nuovaQty }).eq('id', comp.oggetto_id);
            }
            await callEmailFunction(`üéÅ PACCHETTO: Prelevato "${packNome}". Tutti i componenti sono stati aggiornati.`);
            alert("Pacchetto scaricato con successo!");
            loadInventory();
        }
    }

    async function callEmailFunction(messaggio) {
        const url = `https://${PROJECT_ID}.supabase.co/functions/v1/notify-admin`;
        try {
            await fetch(url, {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${sbKey}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({ details: messaggio, admin_email: ADMIN_EMAIL })
            });
        } catch (e) { console.error("Errore funzione email:", e); }
    }

    // --- ADMIN ---
    function showSection(type) {
        const content = document.getElementById('admin-content');
        if(type === 'prodotti') {
            content.innerHTML = `
                <h3>Nuovo Prodotto</h3>
                <input type="text" id="p-nome" placeholder="Nome Oggetto">
                <input type="number" id="p-qty" placeholder="Quantit√† Totale">
                <input type="text" id="p-foto" placeholder="URL Immagine">
                <button class="btn" style="background:var(--gold); color:black" onclick="salvaProdotto()">Salva nel Magazzino</button>`;
        } else {
            content.innerHTML = `
                <h3>Nuova Memoria nell'Archivio</h3>
                <input type="text" id="a-evento" placeholder="Evento/Campo">
                <input type="text" id="a-luogo" placeholder="Luogo">
                <textarea id="a-aneddoto" placeholder="Scrivi un ricordo..."></textarea>
                <button class="btn" style="background:var(--gold); color:black" onclick="salvaMemoria()">Archivia Storia</button>`;
        }
    }

    async function salvaProdotto() {
        const nome = document.getElementById('p-nome').value;
        const qty = document.getElementById('p-qty').value;
        const foto = document.getElementById('p-foto').value;
        await _supabase.from('oggetti').insert([{ nome, quantita_disponibile: qty, foto_url: foto }]);
        alert("Prodotto aggiunto!"); loadInventory();
    }

    async function salvaMemoria() {
        const evento = document.getElementById('a-evento').value;
        const luogo = document.getElementById('a-luogo').value;
        const aneddoto = document.getElementById('a-aneddoto').value;
        await _supabase.from('archivio').insert([{ evento, luogo, aneddoto }]);
        alert("Storia salvata!");
    }

    function changeQtyValue(id, delta) {
        const input = document.getElementById(`qty-${id}`);
        let newVal = parseInt(input.value) + delta;
        if(newVal >= 1 && newVal <= input.max) input.value = newVal;
    }

    async function checkAdmin() {
        const { data: { user } } = await _supabase.auth.getUser();
        if(user) {
            const { data: p } = await _supabase.from('profili').select('ruolo').eq('id', user.id).single();
            if(p?.ruolo === 'admin') {
                document.getElementById('admin-panel').style.display = 'block';
                document.getElementById('btn-login').style.display = 'none';
                document.getElementById('btn-logout').style.display = 'block';
            }
        }
    }

    function loginAdmin() {
        const e = prompt("Email Admin:");
        const p = prompt("Password Admin:");
        _supabase.auth.signInWithPassword({ email: e, password: p }).then(() => location.reload());
    }

    function logoutAdmin() { _supabase.auth.signOut().then(() => location.reload()); }

    init();
</script>
</body>
</html>
