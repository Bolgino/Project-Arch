<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Punto ArchiQuadro</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --green: #1b5e20; --gold: #fbc02d; --bg: #f4f4f4; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; padding: 20px; }
        .container { max-width: 1200px; margin: auto; }
        .header { background: var(--green); color: white; padding: 20px; border-radius: 12px; display: flex; justify-content: space-between; align-items: center; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; margin-top: 20px; }
        .card { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); text-align: center; }
        .card img { height: 120px; object-fit: contain; margin-bottom: 10px; }
        .btn { background: var(--green); color: white; border: none; padding: 12px; border-radius: 8px; cursor: pointer; width: 100%; font-weight: bold; }
        #admin-panel { display: none; background: #fff3e0; padding: 30px; border-radius: 20px; margin-top: 40px; border: 2px dashed #ff9800; }
        input { width: 100%; padding: 10px; margin: 10px 0; border-radius: 8px; border: 1px solid #ccc; box-sizing: border-box; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>‚öúÔ∏è Punto ArchiQuadro</h1>
        <div id="auth-buttons">
            <button onclick="loginAdmin()" id="btn-login" style="padding:10px; cursor:pointer;">Login Admin</button>
            <button onclick="logoutAdmin()" id="btn-logout" style="display:none; padding:10px; cursor:pointer; background:red; color:white; border:none; border-radius:5px;">Esci</button>
        </div>
    </div>

    <div id="public-view">
        <h2 style="color:var(--green)">üì¶ Magazzino Singolo</h2>
        <div id="oggetti-lista" class="grid"></div>
    </div>

    <div id="admin-panel">
        <h2>üõ†Ô∏è Pannello Admin</h2>
        <p>Benvenuto, Capo Gruppo.</p>
    </div>
</div>

<script>
    const PROJECT_ID = "jmildwxjaviqkrkhjzhl";
    const ADMIN_EMAIL = "marcobolge@gmail.com"; 

    // Recupero chiavi con controllo anti-errore
    let sbUrl = localStorage.getItem('sb-url') || `https://${PROJECT_ID}.supabase.co`;
    let sbKey = localStorage.getItem('sb-key');

    if (!sbKey || sbKey === "null") {
        sbKey = prompt("Inserisci la tua API Key (anon public) di Supabase:");
        if (sbKey) localStorage.setItem('sb-key', sbKey.trim());
    }

    const _supabase = supabase.createClient(sbUrl, sbKey);

    async function loadInventory() {
        const { data: oggetti, error } = await _supabase.from('oggetti').select('*').order('nome');
        if (error) {
            console.error("Errore Supabase:", error);
            if(error.message.includes("Key")) { localStorage.clear(); location.reload(); }
            return;
        }
        
        const container = document.getElementById('oggetti-lista');
        // Usiamo placehold.co che √® pi√π stabile
        container.innerHTML = oggetti.map(o => `
            <div class="card">
                <img src="${o.foto_url || 'https://placehold.co/150x150?text=Oggetto'}" alt="${o.nome}">
                <h3>${o.nome}</h3>
                <p>Disp: <strong>${o.quantita_disponibile}</strong></p>
                <button class="btn" onclick="confermaPrelievo('${o.id}', '${o.nome}', ${o.quantita_disponibile})">Conferma Prelievo</button>
            </div>
        `).join('');
    }

    async function confermaPrelievo(id, nome, attuale) {
        if(!confirm(`Prelevare 1x ${nome}?`)) return;

        const { error } = await _supabase.from('oggetti').update({ quantita_disponibile: attuale - 1 }).eq('id', id);
        if(!error) {
            await callEmailFunction(`üì¶ PRELIEVO: 1x ${nome}. Rimanenti: ${attuale - 1}`);
            alert("Riepilogo inviato via mail!");
            loadInventory();
        }
    }

    async function callEmailFunction(messaggio) {
        const url = `https://${PROJECT_ID}.supabase.co/functions/v1/notify-admin`;
        try {
            const response = await fetch(url, {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${sbKey}`,
                    'apikey': sbKey
                },
                body: JSON.stringify({ details: messaggio, admin_email: ADMIN_EMAIL })
            });
            const resData = await response.json();
            console.log("Esito Email:", resData);
        } catch (e) {
            console.error("Errore invio mail:", e);
        }
    }

    async function checkAdmin() {
        const { data: { user } } = await _supabase.auth.getUser();
        if(user) {
            document.getElementById('btn-login').style.display = 'none';
            document.getElementById('btn-logout').style.display = 'block';
            document.getElementById('admin-panel').style.display = 'block';
        }
    }

    function loginAdmin() {
        const e = prompt("Email:");
        const p = prompt("Password:");
        _supabase.auth.signInWithPassword({ email: e, password: p }).then(() => location.reload());
    }

    function logoutAdmin() { _supabase.auth.signOut().then(() => location.reload()); }

    checkAdmin();
    loadInventory();
</script>
</body>
</html>
