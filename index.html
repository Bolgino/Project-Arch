<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Punto ArchiQuadro</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --green: #1b5e20; --gold: #fbc02d; --red: #d32f2f; --bg: #f4f4f4; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; padding: 20px; }
        .container { max-width: 1200px; margin: auto; }
        .header { background: var(--green); color: white; padding: 20px; border-radius: 12px; display: flex; justify-content: space-between; align-items: center; }
        
        /* Griglia Prodotti */
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; margin-top: 20px; }
        .card { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); text-align: center; border: 1px solid #ddd; }
        .card img { height: 120px; object-fit: contain; margin-bottom: 10px; }
        
        /* Selettore Quantit√† */
        .qty-box { display: flex; align-items: center; justify-content: center; gap: 10px; margin: 15px 0; }
        .qty-input { width: 50px; text-align: center; font-weight: bold; padding: 5px; border-radius: 5px; border: 1px solid #ccc; }
        
        .btn { background: var(--green); color: white; border: none; padding: 12px; border-radius: 8px; cursor: pointer; width: 100%; font-weight: bold; }
        .btn-pack { background: var(--gold); color: #333; margin-bottom: 10px; }
        .out-of-stock { color: var(--red); font-weight: bold; padding: 10px; border: 2px solid var(--red); border-radius: 8px; }

        /* Admin */
        #admin-panel { display: none; background: #fff3e0; padding: 30px; border-radius: 20px; margin-top: 40px; border: 2px dashed #ff9800; }
        .admin-nav { margin-bottom: 20px; }
        .admin-nav button { margin-right: 10px; padding: 10px; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>‚öúÔ∏è Punto ArchiQuadro</h1>
        <div id="auth-buttons">
            <button onclick="loginAdmin()" id="btn-login" style="padding:10px;">Login Admin</button>
            <button onclick="logoutAdmin()" id="btn-logout" style="display:none; padding:10px;">Esci</button>
        </div>
    </div>

    <div id="public-view">
        <h2 style="color:var(--green)">üì¶ Magazzino Capi</h2>
        <div id="pacchetti-lista" class="grid"></div>
        <div id="oggetti-lista" class="grid"></div>
    </div>

    <div id="admin-panel">
        <h2>üõ†Ô∏è Gestione Super-Admin</h2>
        <div class="admin-nav">
            <button onclick="showSection('prodotti')">Prodotti</button>
            <button onclick="showSection('archivio')">Archivio</button>
        </div>
        <div id="admin-content">
            <p>Seleziona una sezione sopra per iniziare.</p>
        </div>
    </div>
</div>

<script>
    const _supabase = supabase.createClient(localStorage.getItem('sb-url'), localStorage.getItem('sb-key'));

    async function init() {
        checkAdmin();
        loadInventory();
    }

    // --- FUNZIONI MAGAZZINO ---
    async function loadInventory() {
        const { data: oggetti } = await _supabase.from('oggetti').select('*').order('nome');
        const container = document.getElementById('oggetti-lista');
        
        container.innerHTML = oggetti.map(o => {
            const isOut = o.quantita_disponibile <= 0;
            return `
                <div class="card">
                    <img src="${o.foto_url || 'https://via.placeholder.com/150?text=Senza+Foto'}" alt="${o.nome}">
                    <h3>${o.nome}</h3>
                    ${isOut ? 
                        `<div class="out-of-stock">ESAURITO (In ordine)</div>` : 
                        `<p>Disponibili: <strong>${o.quantita_disponibile}</strong></p>
                         <div class="qty-box">
                            <button onclick="changeQtyValue('${o.id}', -1)">-</button>
                            <input type="number" id="qty-${o.id}" class="qty-input" value="1" min="1" max="${o.quantita_disponibile}">
                            <button onclick="changeQtyValue('${o.id}', 1)">+</button>
                         </div>
                         <button class="btn" onclick="confermaPrelievo('${o.id}', '${o.nome}', ${o.quantita_disponibile}, ${o.soglia_minima})">Conferma Prelievo</button>`
                    }
                </div>`;
        }).join('');
    }

    function changeQtyValue(id, delta) {
        const input = document.getElementById(`qty-${id}`);
        let newVal = parseInt(input.value) + delta;
        if(newVal >= 1 && newVal <= input.max) input.value = newVal;
    }

    async function confermaPrelievo(id, nome, attuale, soglia) {
        const qty = parseInt(document.getElementById(`qty-${id}`).value);
        if(!confirm(`Confermi di prelevare ${qty} pezzi di "${nome}"?`)) return;

        const nuovaQty = attuale - qty;
        const { error } = await _supabase.from('oggetti').update({ quantita_disponibile: nuovaQty }).eq('id', id);

        if(!error) {
            alert("Magazzino aggiornato! Riepilogo inviato all'admin.");
            if(nuovaQty <= soglia) {
                // Qui scatta la Edge Function per la mail di allerta
                console.log("ALERT: Sotto soglia!");
            }
            loadInventory();
        }
    }

    // --- ADMIN ---
    async function checkAdmin() {
        const { data: { user } } = await _supabase.auth.getUser();
        if(user) {
            const { data: p } = await _supabase.from('profili').select('ruolo').eq('id', user.id).single();
            if(p?.ruolo === 'admin') {
                document.getElementById('admin-panel').style.display = 'block';
                document.getElementById('btn-login').style.display = 'none';
                document.getElementById('btn-logout').style.display = 'block';
            }
        }
    }

    function loginAdmin() {
        const e = prompt("Email Admin:");
        const p = prompt("Password:");
        _supabase.auth.signInWithPassword({ email: e, password: p }).then(() => location.reload());
    }

    function logoutAdmin() { _supabase.auth.signOut().then(() => location.reload()); }

    init();
</script>
</body>
</html>
